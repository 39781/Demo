<html>
<head>
<meta name="google-signin-client_id" content="93244704256-qao2ngc31bb93k1uifsn42ffo5rmsbs1.apps.googleusercontent.com"></meta>
<script src="//ajax.googleapis.com/ajax/libs/jquery/1.8.2/jquery.min.js"></script>
<script src="https://apis.google.com/js/platform.js" async defer></script>
<script>
(function(d, s, id){
  var js, fjs = d.getElementsByTagName(s)[0];
  if (d.getElementById(id)) {return;}
  js = d.createElement(s); js.id = id;
  js.src = "//connect.facebook.com/en_US/messenger.Extensions.js";
  fjs.parentNode.insertBefore(js, fjs);
}(document, 'script', 'Messenger'));
window.extAsyncInit = function() {
  // the Messenger Extensions JS SDK is done loading 
};

function onSignIn(googleUser) {
	var profile = googleUser.getBasicProfile();
	var id_token = googleUser.getAuthResponse().id_token;  
	console.log('Name: ' + profile.getName());	
	var xhr = new XMLHttpRequest();
	xhr.onreadystatechange = function() {
		console.log(this.readyState);
		if (this.readyState == 4 && this.status == 200) {
			document.getElementById("status").innerHTML = "user validated : login success";
			return webViewClose(profile.getName());		   
		}else{
			document.getElementById("status").innerHTML = "Invalid user please sign in with valid user";
		}
	};
	xhr.open('POST', 'https://desolate-beach-84758.herokuapp.com/validateUser',true);
	xhr.setRequestHeader("Content-Type", "application/json;charset=UTF-8");		
	xhr.send(JSON.stringify({accessToken:id_token}));
}

function webViewClose(name){
	let message = {
		"attachment":{
			"type":"template",
			"payload":{
			  "template_type":"generic",
			  "elements": [{
				"title":name,
				"image_url": "https://bot.peters-hats.com/img/hats/fez.jpg",
				"subtitle": "Welcome to Demobot"				
			  }]
			}
		}
	};
	MessengerExtensions.beginShareFlow(function(share_response) {
	  // User dismissed without error, but did they share the message?
	  if(share_response.is_sent){
		MessengerExtensions.requestCloseBrowser(function success() {
		
		}, function error(err) {
		  // an error occurred
		});
	  }
	}, 
	function(errorCode, errorMessage) {      
	// An error occurred in the process

	},
	message,
	"current_thread");	
}
</script>

</head>
<body>
<div class="g-signin2" data-onsuccess="onSignIn"></div>
<div id="status"></div>
</body>
</html>