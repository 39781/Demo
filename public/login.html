<html>
<head>
<meta name="google-signin-client_id" content="93244704256-qao2ngc31bb93k1uifsn42ffo5rmsbs1.apps.googleusercontent.com"></meta>
<script src="//ajax.googleapis.com/ajax/libs/jquery/1.8.2/jquery.min.js"></script>
<script src="https://apis.google.com/js/platform.js" async defer></script>
<script>
(function(d, s, id){
  var js, fjs = d.getElementsByTagName(s)[0];
  if (d.getElementById(id)) {return;}
  js = d.createElement(s); js.id = id;
  js.src = "//connect.facebook.com/en_US/messenger.Extensions.js";
  fjs.parentNode.insertBefore(js, fjs);
}(document, 'script', 'Messenger'));
window.extAsyncInit = function() {
  // the Messenger Extensions JS SDK is done loading 
};

function onSignIn(googleUser) {
	var profile = googleUser.getBasicProfile();
	var id_token = googleUser.getAuthResponse().id_token;  
	console.log('Name: ' + profile.getName());

	var xhr = new XMLHttpRequest();
	xhr.onreadystatechange = function() {
		if (this.readyState == 4 && this.status == 200) {
		   return webViewClose();		   
		}else{
			document.getElementById("status").innerHTML = "Invalid user please sign in with valid user";
		}
	};
	xhr.open('GET', 'https://https://desolate-beach-84758.herokuapp.com/validateUser/'+id_token,true);
	xhr.setRequestHeader('Content-Type', 'application/x-www-form-urlencoded');		
	xhr.send();
}

function webViewClose(){
	let message = {
		"attachment":{
			"type":"template",
			"payload":{
			  "template_type":"generic",
			  "elements": [{
				"title":profile.getName(),
				"image_url": "https://bot.peters-hats.com/img/hats/fez.jpg",
				"subtitle": "My result: Fez",
				"default_action":{
				  "type":"web_url",
				  "url": "https://bot.peters-hats.com/view_quiz_results.php?user=24601"
				},
				"buttons":[{
				  "type":"web_url",
				  "url":"https://bot.peters-hats.com/hatquiz.php?referer=24601",
				  "title":"Take the Quiz"
				}]
			  }]
			}
		}
	};
	MessengerExtensions.beginShareFlow(function(share_response) {
	  // User dismissed without error, but did they share the message?
	  if(share_response.is_sent){
		MessengerExtensions.requestCloseBrowser(function success() {
		
		}, function error(err) {
		  // an error occurred
		});
	  }
	}, 
	function(errorCode, errorMessage) {      
	// An error occurred in the process

	},
	message,
	"broadcast");	
}
</script>

</head>
<body>
<div class="g-signin2" data-onsuccess="onSignIn"></div>
<div id="status"></div>
</body>
</html>